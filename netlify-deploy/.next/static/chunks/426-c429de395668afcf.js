"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[426],{8728:function(e,t,o){o.d(t,{Mo:function(){return s},aF:function(){return a},cL:function(){return r}}),o(4090);let a=()=>({isLoaded:!0,isSignedIn:!0,user:{id:"mock-user-id",firstName:"Demo",lastName:"User",username:"demo",fullName:"Demo User",imageUrl:"https://via.placeholder.com/150",primaryEmailAddress:{emailAddress:"demo@example.com"},getMetadata:()=>({})}}),r=e=>{let{redirectUrl:t}=e;return null},s=e=>{let{redirectUrl:t}=e;return null}},5922:function(e,t,o){o.d(t,{$g:function(){return i},Bi:function(){return s},Hq:function(){return r},KG:function(){return f},OQ:function(){return a},Sk:function(){return l},cT:function(){return d},qm:function(){return m},tL:function(){return h}});let a=(0,o(9377).eI)("https://cvjfytrbzfqwxszhcmvq.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2amZ5dHJiemZxd3hzemhjbXZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDEwMDc3ODUsImV4cCI6MjA1NjU4Mzc4NX0.tGEazNPRhhCuQ_PZOOm2lNIa7IIXAbOF_ZJLhSjUuaw"),r=async e=>{try{console.log("Attempting to save song:",{...e,url:"REDACTED"});let t={...e,user_id:String(e.user_id)},{data:o,error:r}=await a.from("songs").insert([t]).select().single();if(r)throw console.error("Supabase error details:",{message:r.message,details:r.details,hint:r.hint,code:r.code}),Error("Failed to save song: ".concat(r.message));if(!o)throw Error("No data returned from insert operation");return console.log("Song saved successfully:",{id:o.id,title:o.title}),o}catch(e){throw console.error("Error in saveSong:",e),e}};async function s(e){let{data:t,error:o}=await a.from("songs").select("*").eq("user_id",e).order("created_at",{ascending:!1});if(o)throw o;return t||[]}let l=async e=>{let{error:t}=await a.from("songs").delete().eq("id",e);if(t)throw t},i=async(e,t)=>{try{console.log("Attempting to update song:",{songId:e,updates:t});let{data:o,error:r}=await a.from("songs").update(t).eq("id",e).select().single();if(r)throw console.error("Supabase error details:",{message:r.message,details:r.details,hint:r.hint,code:r.code}),Error("Failed to update song: ".concat(r.message));if(!o)throw Error("No data returned from update operation");return console.log("Song updated successfully:",{id:o.id,title:o.title}),o}catch(e){throw console.error("Error in updateSongDetails:",e),e}},n=["templates","media","music","generated"];async function c(e){try{console.log("Creating public bucket '".concat(e,"'..."));let{error:t}=await a.storage.createBucket(e,{public:!0,fileSizeLimit:10485760,allowedMimeTypes:["image/*","video/*","audio/*"]});if(t)return console.warn("Error creating bucket '".concat(e,"': ").concat(t.message)),!1;return console.log("Successfully created bucket '".concat(e,"'")),!0}catch(t){return console.warn("Exception creating bucket '".concat(e,"':"),t),!1}}async function d(e,t,o){try{var a,r,s,l,i,n,d,m,f,p,h,v;try{await g(t)}catch(e){console.warn("Could not verify bucket '".concat(t,"', but will try upload anyway:"),e)}let w=await u(t,o,e);if(!w.success&&(null===(r=w.error)||void 0===r?void 0:null===(a=r.message)||void 0===a?void 0:a.includes("bucket"))&&(console.log("Bucket '".concat(t,"' not found, attempting to create it...")),await c(t)&&(w=await u(t,o,e))),!w.success){if((null===(l=w.error)||void 0===l?void 0:null===(s=l.message)||void 0===s?void 0:s.includes("bucket"))||(null===(n=w.error)||void 0===n?void 0:null===(i=n.message)||void 0===i?void 0:i.includes("Bucket")))throw Error("The storage bucket '".concat(t,"' does not exist or you don't have access to it. Please contact your administrator."));if((null===(m=w.error)||void 0===m?void 0:null===(d=m.message)||void 0===d?void 0:d.includes("permission"))||(null===(p=w.error)||void 0===p?void 0:null===(f=p.message)||void 0===f?void 0:f.includes("access"))||(null===(v=w.error)||void 0===v?void 0:null===(h=v.message)||void 0===h?void 0:h.includes("policy")))throw Error("You don't have permission to upload to '".concat(t,"'. This may be due to Row-Level Security (RLS) policies."));throw w.error||Error("Unknown upload error")}return w.data}catch(e){throw console.error("Error uploading file to bucket '".concat(t,"':"),e),e}}async function u(e,t,o){try{let{data:r,error:s}=await a.storage.from(e).upload(t,o,{cacheControl:"3600",upsert:!0});return{success:!s,data:r,error:s}}catch(e){return{success:!1,data:null,error:e instanceof Error?e:Error(String(e))}}}async function g(e){try{let{data:t,error:o}=await a.storage.listBuckets();if(o){console.warn("Permission error listing buckets: ".concat(o.message));return}if(!t){console.warn("No buckets data returned from Supabase");return}if(t.some(t=>t.name===e))console.log("Bucket '".concat(e,"' already exists"));else{console.log("Bucket '".concat(e,"' does not exist. Attempting to create..."));try{let{error:t}=await a.storage.createBucket(e,{public:!0,fileSizeLimit:10485760});t?console.warn("Could not create bucket '".concat(e,"': ").concat(t.message)):console.log("Bucket '".concat(e,"' created successfully"))}catch(t){console.warn("Exception creating bucket '".concat(e,"':"),t)}}}catch(t){console.warn("Error checking bucket '".concat(e,"':"),t)}}async function m(e,t){let{data:o}=a.storage.from(e).getPublicUrl(t);return o.publicUrl}async function f(){console.log("Initializing Supabase storage buckets...");let e={success:[],failed:[]},t=!1;try{let{data:e,error:o}=await a.storage.listBuckets();(t=!o&&Array.isArray(e))?console.log("User has admin access to storage buckets"):console.warn("User does not have admin access to list buckets:",null==o?void 0:o.message)}catch(e){console.warn("Error checking admin access:",e)}for(let o of n)try{let r=!1;if(t?(await g(o),r=!0):r=await c(o),r)e.success.push(o);else try{let t=new File(["test"],"test.txt",{type:"text/plain"}),r="test-".concat(Date.now(),".txt"),s=await u(o,r,t);if(s.success){console.log("Bucket '".concat(o,"' exists and is usable")),e.success.push(o);try{await a.storage.from(o).remove([r])}catch(e){}}else console.warn("Bucket '".concat(o,"' is not usable:"),s.error),e.failed.push(o)}catch(t){console.warn("Could not verify bucket '".concat(o,"' usability:"),t),e.failed.push(o)}}catch(t){console.warn("Failed to initialize bucket '".concat(o,"':"),t),e.failed.push(o)}return e.success.length>0&&console.log("Successfully initialized buckets: ".concat(e.success.join(", "))),e.failed.length>0&&console.warn("Failed to initialize buckets: ".concat(e.failed.join(", "))),e.success.length>0}class p{static isAvailable(){try{return window.localStorage&&window.indexedDB}catch(e){return!1}}static async storeFile(e,t,o){return new Promise((a,r)=>{try{let s="local_storage_".concat(t,"_").concat(o.replace(/[^a-zA-Z0-9]/g,"_")),l=new FileReader;l.onload=()=>{try{localStorage.setItem(s,l.result),console.log("File stored locally with key: ".concat(s)),a(s)}catch(e){console.error("Error storing file in localStorage:",e),r(e)}},l.onerror=()=>r(Error("Failed to read file")),l.readAsDataURL(e)}catch(e){r(e)}})}static getFileUrl(e){try{return localStorage.getItem(e)}catch(e){return console.error("Error retrieving file from localStorage:",e),null}}}async function h(e,t,o){try{console.log("Attempting to upload to Supabase bucket '".concat(t,"'..."));try{let a=await d(e,t,o);return console.log("Successfully uploaded to Supabase"),{storage:"supabase",path:o,bucket:t,data:a}}catch(a){if(console.warn("Supabase upload failed, trying local storage fallback:",a),p.isAvailable()){let a=await p.storeFile(e,t,o);return console.log("Successfully stored in local storage"),{storage:"local",path:a,bucket:"local",data:{path:a}}}throw Error("Local storage fallback is not available")}}catch(e){throw console.error("All storage methods failed:",e),e}}},9129:function(e,t,o){o.d(t,{B:function(){return n}});var a=o(2574),r=o(1231),s=o(9414);let l={templateImage:null,templatePosition:{x:0,y:0,scale:1},templateDuration:3,mediaFiles:[],selectedSongs:[],cachedSongs:[],hooks:[],selectedFonts:{withBackground:!0,normal:!1},generatedImages:[],generatedVideos:[]},i=(e,t)=>{try{let o={...t,mediaFiles:t.mediaFiles.map(e=>({...e,persisted:e.url.length<=20971520,url:e.url.length>20971520?null:e.url}))};localStorage.setItem(e,JSON.stringify(o))}catch(t){if(t instanceof Error&&(console.warn("Storage failed:",t.message),"QuotaExceededError"===t.name))try{let t=JSON.parse(localStorage.getItem(e)||"{}");t.mediaFiles&&(t.mediaFiles=t.mediaFiles.map(e=>({...e,persisted:!1,url:null})),localStorage.setItem(e,JSON.stringify(t)))}catch(e){console.error("Failed to clean up storage:",e)}}},n=(0,a.U)(e=>{let t=localStorage.getItem("bluum-storage"),o=t?{...l,...JSON.parse(t)}:l;o.mediaFiles&&(o.mediaFiles=o.mediaFiles.filter(e=>null!==e.url&&""!==e.url).map(e=>({...e,persisted:!0})));let a=t=>{e(e=>{let o={...e,...t};return i("bluum-storage",{mediaFiles:o.mediaFiles,templateImage:o.templateImage,templatePosition:o.templatePosition,templateDuration:o.templateDuration,hooks:o.hooks,selectedFonts:o.selectedFonts,generatedImages:o.generatedImages,generatedVideos:o.generatedVideos}),o})};return{...o,setTemplateImage:e=>a({templateImage:e}),setTemplatePosition:e=>a({templatePosition:e}),setTemplateDuration:e=>a({templateDuration:e}),addMediaFile:e=>{var t;let o=n.getState();if(((null===(t=o.mediaFiles)||void 0===t?void 0:t.length)||0)>=10){s.toast.error("Vous ne pouvez pas uploader plus de ".concat(10," fichiers au total"));return}if(e.url.length>20971520){s.toast.error("Le fichier est trop grand. Maximum 20MB par fichier.");return}a({mediaFiles:[...o.mediaFiles||[],{...e,id:(0,r.Z)(),persisted:!0}]})},removeMediaFile:e=>{var t;a({mediaFiles:(null===(t=n.getState().mediaFiles)||void 0===t?void 0:t.filter(t=>t.id!==e))||[]})},removeMediaFiles:e=>{var t;a({mediaFiles:(null===(t=n.getState().mediaFiles)||void 0===t?void 0:t.filter(t=>!e.includes(t.id)))||[]})},addSong:e=>{a({selectedSongs:[...n.getState().selectedSongs||[],{...e,id:e.id||(0,r.Z)()}]})},removeSong:e=>{var t;a({selectedSongs:(null===(t=n.getState().selectedSongs)||void 0===t?void 0:t.filter(t=>t.id!==e))||[]})},updateSong:(e,t)=>{var o;a({selectedSongs:(null===(o=n.getState().selectedSongs)||void 0===o?void 0:o.map(o=>o.id===e?{...o,...t}:o))||[]})},clearSongs:()=>a({selectedSongs:[]}),setCachedSongs:e=>a({cachedSongs:e}),addHook:e=>{a({hooks:[...n.getState().hooks||[],{...e,id:(0,r.Z)()}]})},removeHook:e=>{var t;a({hooks:(null===(t=n.getState().hooks)||void 0===t?void 0:t.filter(t=>t.id!==e))||[]})},updateHookPosition:(e,t)=>{var o;a({hooks:(null===(o=n.getState().hooks)||void 0===o?void 0:o.map(o=>o.id===e?{...o,position:t}:o))||[]})},toggleFont:e=>{var t;let o=n.getState();a({selectedFonts:{...o.selectedFonts||{withBackground:!0,normal:!1},[e]:!(null===(t=o.selectedFonts)||void 0===t?void 0:t[e])}})},addGeneratedImage:e=>{a({generatedImages:[...n.getState().generatedImages||[],{...e,id:(0,r.Z)()}]})},addGeneratedVideo:e=>{a({generatedVideos:[...n.getState().generatedVideos||[],{...e,id:(0,r.Z)()}]})},clearGeneratedContent:()=>a({generatedImages:[],generatedVideos:[]}),reset:()=>a(l)}})}}]);